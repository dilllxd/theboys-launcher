name: Build TheBoys Launcher

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  VERSION_FILE: version.env

jobs:
  build:
    name: Build Applications
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            binary_name: TheBoysLauncher
            artifact_name: TheBoysLauncher-Linux
          - os: windows-latest
            platform: windows
            binary_name: TheBoysLauncher.exe
            artifact_name: TheBoysLauncher-Windows
          - os: macos-latest
            platform: darwin
            binary_name: TheBoysLauncher
            artifact_name: TheBoysLauncher-macOS
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '^1.23'
        cache: true
        cache-dependency-path: go.sum

    - name: Get version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          source ./scripts/get-version.sh
          VERSION="$FULL_VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglfw3-dev libx11-dev libxcursor-dev libxinerama-dev libxi-dev libxrandr-dev libxext-dev libxfixes-dev libxxf86vm-dev pkg-config

    - name: Install Go dependencies
      run: go mod download

    - name: Build binary
      run: |
        # Build for native platform only to avoid OpenGL cross-compilation issues
        go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" -o ${{ matrix.binary_name }} .

    - name: Make binary executable (Unix)
      if: matrix.platform != 'windows'
      run: chmod +x ${{ matrix.binary_name }}

    - name: Create macOS native executable
      if: matrix.platform == 'darwin'
      run: |
        echo "Creating macOS native executable..."

        # Build natively (GitHub Actions macOS runners are typically Intel)
        echo "Building macOS binary..."
        go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" -o TheBoysLauncher-macos .

        # Make executable
        chmod +x TheBoysLauncher-macos

        # Show file info
        echo "macOS binary created:"
        file TheBoysLauncher-macos
        ls -la TheBoysLauncher-macos

    - name: Build Windows installer
      if: matrix.platform == 'windows'
      run: |
        # Add WiX to PATH
        echo "C:\Program Files (x86)\WiX Toolset v3.11" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        # Create simple installer using candle and light
        $version = "${{ steps.version.outputs.version }}"

        $wxsContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
          <Product Id="*" Name="TheBoys Launcher" Language="1033" Version="$version" Manufacturer="Dylan" UpgradeCode="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E6F">
            <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" Description="TheBoys Minecraft Modpack Launcher" Platform="x64" />
            <MediaTemplate EmbedCab="yes" />
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <Feature Id="ProductFeature" Title="TheBoys Launcher" Level="1">
              <ComponentRef Id="MainExecutable" />
              <ComponentRef Id="ApplicationShortcut" />
            </Feature>
            <Directory Id="TARGETDIR" Name="SourceDir">
              <Directory Id="LocalAppDataFolder">
                <Directory Id="INSTALLFOLDER" Name="TheBoysLauncher" />
              </Directory>
              <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="TheBoys Launcher"/>
              </Directory>
            </Directory>
            <Component Id="MainExecutable" Directory="INSTALLFOLDER" Guid="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E70">
              <File Id="TheBoysLauncherEXE" Source="TheBoysLauncher.exe" />
              <RemoveFile Id="RemoveMainExecutable" Name="TheBoysLauncher.exe" On="uninstall" />
              <RegistryKey Root="HKCU" Key="Software\TheBoysLauncher">
                <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLFOLDER]" />
                <RegistryValue Type="string" Name="Version" Value="$version" />
                <RegistryValue Type="string" Name="MainExecutable" Value="[#TheBoysLauncherEXE]" KeyPath="yes" />
              </RegistryKey>
              <Shortcut Id="ApplicationStartMenuShortcut" Directory="ApplicationProgramsFolder" Name="TheBoys Launcher" Description="TheBoys Minecraft Modpack Launcher" Target="[#TheBoysLauncherEXE]" WorkingDirectory="INSTALLFOLDER" />
            </Component>
            <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder" Guid="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E74">
              <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
              <RegistryValue Root="HKCU" Key="Software\TheBoysLauncher" Name="shortcut" Type="integer" Value="1" KeyPath="yes" />
            </Component>
            <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
            <UIRef Id="WixUI_InstallDir" />
          </Product>
        </Wix>
        "@

        $wxsContent | Out-File -FilePath "installer.wxs" -Encoding utf8
        candle.exe installer.wxs
        light.exe -ext WixUIExtension -out "TheBoysLauncher-Setup-$version.msi" installer.wixobj
        Remove-Item installer.wxs, installer.wixobj -ErrorAction SilentlyContinue

    - name: Upload primary binary
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.binary_name }}
        retention-days: 30

    - name: Upload macOS native executable
      if: matrix.platform == 'darwin'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-Native
        path: TheBoysLauncher-macos
        retention-days: 30

    - name: Upload Windows installer
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-Installer
        path: TheBoysLauncher-Setup-*.msi
        retention-days: 30

    - name: Show build summary
      run: |
        echo "âœ… Build completed successfully!"
        echo "Platform: ${{ matrix.platform }}"
        echo "Version: ${{ steps.version.outputs.version }}"
        if [ "${{ matrix.platform }}" = "darwin" ]; then
          echo "Artifacts: Native binary + macOS-specific binary"
        elif [ "${{ matrix.platform }}" = "windows" ]; then
          echo "Artifacts: Binary + MSI installer"
        else
          echo "Artifacts: Binary only"
        fi
        ls -la ${{ matrix.binary_name }}* 2>/dev/null || true