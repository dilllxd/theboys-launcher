name: macOS Build and Test

# Trigger on pushes and pull requests to macos-support branch
on:
  push:
    branches: [ macos-support ]
  pull_request:
    branches: [ macos-support ]
  workflow_dispatch:

jobs:
  # macOS builds only - faster and more focused
  build-macos:
    name: macOS ${{ matrix.arch }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: Intel
            goarch: amd64
            bundle_arch: amd64
            artifact_name: TheBoysLauncher-macOS-Intel
          - arch: Apple Silicon
            goarch: arm64
            bundle_arch: arm64
            artifact_name: TheBoysLauncher-macOS-AppleSilicon

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.mod') }}-
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Build macOS ${{ matrix.arch }}
      timeout-minutes: 8
      run: |
        echo "Building macOS ${{ matrix.arch }}..."
        export GOARCH=${{ matrix.goarch }} CGO_ENABLED=1
        go build -ldflags="-s -w -X main.version=v3.0.1-ci" -o build/${{ matrix.goarch }}/TheBoysLauncher .

        echo "âœ… Build completed for macOS ${{ matrix.arch }}!"

        # Verify the executable
        echo "Verifying executable..."
        file build/${{ matrix.goarch }}/TheBoysLauncher
        lipo -info build/${{ matrix.goarch }}/TheBoysLauncher

    - name: Create macOS app bundle
      run: |
        # Verify executable exists and is executable
        if [ ! -f "build/${{ matrix.goarch }}/TheBoysLauncher" ]; then
          echo "âŒ Executable not found: build/${{ matrix.goarch }}/TheBoysLauncher"
          exit 1
        fi

        # Check if executable is actually a Mach-O file
        if ! file "build/${{ matrix.goarch }}/TheBoysLauncher" | grep -q "Mach-O"; then
          echo "âŒ Executable is not a valid Mach-O file"
          file "build/${{ matrix.goarch }}/TheBoysLauncher"
          exit 1
        fi

        echo "âœ… Executable verified, creating app bundle..."
        chmod +x scripts/create-app-bundle.sh
        ./scripts/create-app-bundle.sh ${{ matrix.bundle_arch }} v3.0.1-ci

        if [ -d "build/${{ matrix.bundle_arch }}/TheBoysLauncher.app" ]; then
          echo "âœ… App bundle created successfully!"
          ls -la build/${{ matrix.bundle_arch }}/TheBoysLauncher.app/Contents/MacOS/

          # Verify the bundled executable
          BUNDLED_EXEC="build/${{ matrix.bundle_arch }}/TheBoysLauncher.app/Contents/MacOS/TheBoysLauncher"
          if [ -f "$BUNDLED_EXEC" ]; then
            file "$BUNDLED_EXEC"
            lipo -info "$BUNDLED_EXEC" 2>/dev/null || echo "Single architecture binary"
            du -sh "build/${{ matrix.bundle_arch }}/TheBoysLauncher.app"
            echo "âœ… App bundle executable verified!"
          else
            echo "âŒ Bundled executable not found"
            exit 1
          fi
        else
          echo "âŒ App bundle creation failed"
          exit 1
        fi

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: build/${{ matrix.bundle_arch }}/TheBoysLauncher.app
        retention-days: 7

  # Create Universal macOS binary
  build-universal:
    name: macOS Universal
    runs-on: macos-latest
    needs: build-macos
    if: always() && needs.build-macos.result == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Download Intel build
      uses: actions/download-artifact@v4
      with:
        name: TheBoysLauncher-macOS-Intel
        path: build/amd64/

    - name: Download Apple Silicon build
      uses: actions/download-artifact@v4
      with:
        name: TheBoysLauncher-macOS-AppleSilicon
        path: build/arm64/

    - name: Create Universal binary
      timeout-minutes: 5
      run: |
        mkdir -p build/universal

        # Check what we actually downloaded
        echo "=== Checking downloaded artifacts ==="
        echo "AMD64 contents:"
        ls -la build/amd64/
        echo "ARM64 contents:"
        ls -la build/arm64/

        # Extract raw executables from app bundles
        INTEL_EXEC="build/amd64/TheBoysLauncher.app/Contents/MacOS/TheBoysLauncher"
        ARM_EXEC="build/arm64/TheBoysLauncher.app/Contents/MacOS/TheBoysLauncher"

        if [ -f "$INTEL_EXEC" ]; then
          echo "Found Intel executable in app bundle"
          cp "$INTEL_EXEC" build/amd64/TheBoysLauncher-raw
          file build/amd64/TheBoysLauncher-raw
        else
          echo "âŒ Intel executable not found in app bundle"
          echo "Looking for alternative Intel executable..."
          find build/amd64/ -name "TheBoysLauncher" -type f 2>/dev/null || echo "No Intel executable found"
        fi

        if [ -f "$ARM_EXEC" ]; then
          echo "Found ARM executable in app bundle"
          cp "$ARM_EXEC" build/arm64/TheBoysLauncher-raw
          file build/arm64/TheBoysLauncher-raw
        else
          echo "âŒ ARM executable not found in app bundle"
          echo "Looking for alternative ARM executable..."
          find build/arm64/ -name "TheBoysLauncher" -type f 2>/dev/null || echo "No ARM executable found"
        fi

        # Create universal binary
        if [ -f "build/amd64/TheBoysLauncher-raw" ] && [ -f "build/arm64/TheBoysLauncher-raw" ]; then
          echo "Both executables found, creating universal binary..."
          lipo -create build/amd64/TheBoysLauncher-raw build/arm64/TheBoysLauncher-raw -output build/universal/TheBoysLauncher

          echo "âœ… Universal binary created!"
          file build/universal/TheBoysLauncher
          lipo -info build/universal/TheBoysLauncher
        else
          echo "âŒ Could not create universal binary - missing executables"
          echo "Available files:"
          find build/ -name "*TheBoysLauncher*" 2>/dev/null
          exit 1
        fi

    - name: Create Universal app bundle
      run: |
        chmod +x scripts/create-app-bundle.sh
        ./scripts/create-app-bundle.sh universal v3.0.1-ci

    - name: Verify Universal app bundle
      run: |
        if [ -d "build/universal/TheBoysLauncher.app" ]; then
          echo "âœ… Universal app bundle created!"
          file build/universal/TheBoysLauncher.app/Contents/MacOS/TheBoysLauncher
          lipo -info build/universal/TheBoysLauncher.app/Contents/MacOS/TheBoysLauncher
          du -sh build/universal/TheBoysLauncher.app
        else
          echo "âŒ Universal app bundle creation failed"
          exit 1
        fi

    - name: Upload Universal artifact
      uses: actions/upload-artifact@v4
      with:
        name: TheBoysLauncher-macOS-Universal
        path: build/universal/TheBoysLauncher.app
        retention-days: 7

  # Quick validation
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    needs: [build-macos, build-universal]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Install dependencies for validation
      run: |
        echo "Installing minimal dependencies for syntax checking..."
        sudo apt-get update
        sudo apt-get install -y pkg-config libx11-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev libgl1-mesa-dev

    - name: Basic syntax check
      run: |
        echo "Checking Go syntax..."
        go vet ./... || echo "âš ï¸ Some vet issues found (expected during development)"
        echo "âœ… Syntax check completed!"

    - name: Module verification
      run: |
        echo "Verifying Go modules..."
        go mod verify
        echo "âœ… Module verification completed!"

    - name: Generate build summary
      run: |
        echo "## ðŸš€ macOS Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| macOS Intel | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS Apple Silicon | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS Universal | ${{ needs.build-universal.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.build-macos.result }}" == "success" && "${{ needs.build-universal.result }}" == "success" ]]; then
          echo "ðŸŽ‰ **All macOS builds completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Available Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- TheBoysLauncher-macOS-Intel" >> $GITHUB_STEP_SUMMARY
          echo "- TheBoysLauncher-macOS-AppleSilicon" >> $GITHUB_STEP_SUMMARY
          echo "- TheBoysLauncher-macOS-Universal" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some builds failed** - Check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY