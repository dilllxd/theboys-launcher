name: Build TheBoysLauncher

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  VERSION_FILE: version.env

jobs:
  build:
    name: Build Applications
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            binary_name: TheBoysLauncher
            artifact_name: TheBoysLauncher-Linux
          - os: windows-latest
            platform: windows
            binary_name: TheBoysLauncher.exe
            artifact_name: TheBoysLauncher-Windows
          - os: macos-latest
            platform: darwin
            binary_name: TheBoysLauncher
            artifact_name: TheBoysLauncher-macOS
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '^1.23'
        cache: true
        cache-dependency-path: go.sum

    - name: Get version
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          source ./scripts/get-version.sh
          VERSION="$FULL_VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"



    - name: Install system dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglfw3-dev libx11-dev libxcursor-dev libxinerama-dev libxi-dev libxrandr-dev libxext-dev libxfixes-dev libxxf86vm-dev pkg-config



    - name: Install Go dependencies
      run: go mod download

    - name: Build binary
      run: |
        # Build for native platform only to avoid OpenGL cross-compilation issues
        go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" -o ${{ matrix.binary_name }} .

    - name: Make binary executable (Unix)
      if: matrix.platform != 'windows'
      run: chmod +x ${{ matrix.binary_name }}

    - name: Create macOS native executable
      if: matrix.platform == 'darwin'
      run: |
        echo "Creating macOS native executable..."

        # Build natively (GitHub Actions macOS runners are typically Intel)
        echo "Building macOS binary..."
        go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" -o TheBoysLauncher-macos .

        # Make executable
        chmod +x TheBoysLauncher-macos

        # Show file info
        echo "macOS binary created:"
        file TheBoysLauncher-macos
        ls -la TheBoysLauncher-macos

    - name: Ensure WiX is installed (Windows)
      if: matrix.platform == 'windows'
      run: |
        # If cached WiX bin exists, use it; otherwise install via Chocolatey (try common packages) and cache
        if (Test-Path build-tools-cache\wix\bin) {
          Write-Host "Using cached WiX binaries"
          $cacheBin = Join-Path $PWD "build-tools-cache\wix\bin"
          echo $cacheBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          # Install Chocolatey if not present
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          }

          # Try a few possible Chocolatey package names for WiX
          Write-Host "Installing WiX (trying wixtoolset, then wix)"
          choco install wixtoolset -y --no-progress || choco install wix -y --no-progress || Write-Host "choco install attempted"

          # Try to locate installed candle.exe (primary WiX binary)
          $candleCmd = Get-Command candle.exe -ErrorAction SilentlyContinue
          if ($candleCmd) {
            $wixBin = Split-Path $candleCmd.Source -Parent
          } else {
            # Fallback to common install locations
            $possible = @(
              "C:\\Program Files (x86)\\WiX Toolset v3.11\\bin",
              "C:\\Program Files (x86)\\WiX Toolset v3.14\\bin",
              "C:\\ProgramData\\chocolatey\\lib\\wixtoolset\\tools",
              "C:\\ProgramData\\chocolatey\\lib\\wix\\tools"
            )
            $wixBin = $possible | Where-Object { Test-Path $_ } | Select-Object -First 1
          }

          if (-not $wixBin) {
            Write-Error "WiX binaries not found after installation. Please check available Chocolatey packages or provide a cached build-tools-cache/wix/bin."
            exit 1
          }

          # Copy WiX bin to build-tools-cache so we can cache it for future runs
          New-Item -ItemType Directory -Force -Path build-tools-cache\wix\bin
          Copy-Item -Path (Join-Path $wixBin '*') -Destination build-tools-cache\wix\bin -Recurse -Force
          $cacheBin = Join-Path $PWD "build-tools-cache\wix\bin"
          echo $cacheBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }

    - name: Cache Windows build tools
      if: matrix.platform == 'windows'
      uses: actions/cache@v4
      with:
        path: |
          build-tools-cache
        key: windows-build-tools-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          windows-build-tools-

    - name: Build Windows installer
      if: matrix.platform == 'windows'
      run: |
        # WiX bin directory should already be appended to PATH by the earlier step (from cache or install)
        # Create optimized installer using candle and light
        $version = "${{ steps.version.outputs.version }}"
        Write-Host "Building Windows MSI installer version $version"

        # Create optimized WXS content
        $wxsContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
          <Product Id="*" Name="TheBoysLauncher" Language="1033" Version="$version" Manufacturer="Dylan" UpgradeCode="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E6F">
            <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" Description="TheBoys Minecraft Modpack Launcher" Platform="x64" />
            <MediaTemplate EmbedCab="yes" />
            <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
            <Feature Id="ProductFeature" Title="TheBoysLauncher" Level="1">
              <ComponentRef Id="MainExecutable" />
              <ComponentRef Id="ApplicationShortcut" />
              <ComponentRef Id="DirectoryCleanup" />
            </Feature>
            <Directory Id="TARGETDIR" Name="SourceDir">
              <Directory Id="LocalAppDataFolder">
                <Directory Id="INSTALLFOLDER" Name="TheBoysLauncher" />
              </Directory>
                <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="TheBoysLauncher"/>
              </Directory>
            </Directory>
            <Component Id="MainExecutable" Directory="INSTALLFOLDER" Guid="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E70">
              <File Id="TheBoysLauncherEXE" Source="TheBoysLauncher.exe" />
              <RemoveFile Id="RemoveMainExecutable" Name="TheBoysLauncher.exe" On="uninstall" />
              <RegistryKey Root="HKCU" Key="Software\TheBoysLauncher">
                <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLFOLDER]" />
                <RegistryValue Type="string" Name="Version" Value="$version" />
                <RegistryValue Type="string" Name="MainExecutable" Value="[#TheBoysLauncherEXE]" KeyPath="yes" />
              </RegistryKey>
              <Shortcut Id="ApplicationStartMenuShortcut" Directory="ApplicationProgramsFolder" Name="TheBoysLauncher" Description="TheBoys Minecraft Modpack Launcher" Target="[#TheBoysLauncherEXE]" WorkingDirectory="INSTALLFOLDER" />
            </Component>
            <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder" Guid="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E74">
              <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
              <RegistryValue Root="HKCU" Key="Software\TheBoysLauncher" Name="shortcut" Type="integer" Value="1" KeyPath="yes" />
            </Component>
            <Component Id="DirectoryCleanup" Directory="INSTALLFOLDER" Guid="D5E2B1A3-7C4F-4A2D-9E8F-1A2B3C4D5E75">
              <RemoveFolder Id="RemoveInstallFolder" Directory="INSTALLFOLDER" On="uninstall" />
              <RegistryKey Root="HKCU" Key="Software\TheBoysLauncher">
                <RegistryValue Type="string" Name="DirectoryCleanup" Value="completed" KeyPath="yes" />
              </RegistryKey>
            </Component>
            <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
            <UIRef Id="WixUI_InstallDir" />
          </Product>
        </Wix>
        "@

        # Build MSI with optimizations
        $wxsContent | Out-File -FilePath "installer.wxs" -Encoding utf8

        # Use optimized candle and light options
        candle.exe installer.wxs -out installer.wixobj
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

        light.exe installer.wixobj -ext WixUIExtension -out "TheBoysLauncher-Setup-$version.msi" -sval
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

        # Clean up temporary files
        Remove-Item installer.wxs, installer.wixobj -ErrorAction SilentlyContinue

        Write-Host "MSI installer created successfully: TheBoysLauncher-Setup-$version.msi"

    # NOTE: WiX installation is handled earlier and the path is appended to GITHUB_PATH. Duplicate installation step removed.

    - name: Upload primary binary
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.binary_name }}
        retention-days: 30

    - name: Upload macOS native executable
      if: matrix.platform == 'darwin'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-Native
        path: TheBoysLauncher-macos
        retention-days: 30

    - name: Upload Windows installer
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-Installer
        path: TheBoysLauncher-Setup-*.msi
        retention-days: 30

    - name: Show build summary
      shell: bash
      run: |
        echo "âœ… Build completed successfully!"
        echo "Platform: ${{ matrix.platform }}"
        echo "Version: ${{ steps.version.outputs.version }}"
        if [ "${{ matrix.platform }}" = "darwin" ]; then
          echo "Artifacts: Native binary + macOS-specific binary"
        elif [ "${{ matrix.platform }}" = "windows" ]; then
          echo "Artifacts: Binary + MSI installer"
        else
          echo "Artifacts: Binary only"
        fi
        ls -la ${{ matrix.binary_name }}* 2>/dev/null || true